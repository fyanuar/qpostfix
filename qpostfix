#!/bin/bash
# Copyright (c) 2025 [fyanuar]
# This script is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation, either version 3 of the License.

TARGET=""
QUIET=false
HELP=false

mydate=$(date)

qcount()
{
	myq=$(postqueue -j)
	activ=$(echo "$myq" | jq -s '[.[] | select(.queue_name == "active")] | length')
	incom=$(echo "$myq" | jq -s '[.[] | select(.queue_name == "incoming")] | length')
	defrd=$(echo "$myq" | jq -s '[.[] | select(.queue_name == "deferred")] | length')
	qhold=$(echo "$myq" | jq -s '[.[] | select(.queue_name == "hold")] | length')
	total=$(echo "$myq" | jq -s '[.[] ] | length')
}

for args in "$@"; do
	case "$args" in
		active)
			TARGET="active"
		;;
	
		incoming)
			TARGET="incoming"
		;;
	
		deferred)
			TARGET="deferred"
		;;

		hold)
			TARGET="hold"
		;;

		-h | --help)
			HELP=true
		;;

		-q)
			QUIET=true
		;;
	esac
done

if [ "$HELP" == true ]; then
	echo -e "\nUsage: $(basename $0) [-h | --help] [-q [incoming | active | deferred]]\n"
	echo -e " $(basename $0)       - Queue mail summary"
	echo -e " -h | --help    - this help"
	echo -e " -q             - quiet"
	echo -e " incoming       - incoming queue"
	echo -e " active         - active queue"
	echo -e " deferred       - deferred queue"
	echo -e " hold           - hold queue\n"
elif [ "$TARGET" == "deferred" ]; then
	if [ "$QUIET" = true ]; then
		qcount
		echo "$defrd"
	else
		echo -en "\e[37mCounting queue... \e[33m\e[5mPlease wait.\e[0m"
		qcount
		echo -en "\r\033[0K"
		echo "queie deferred = $defrd"
	fi
elif [ "$TARGET" == "active" ]; then
	if [ "$QUIET" = true ]; then
		qcount
		echo "$activ"
	else
		echo -en "\e[37mCounting queue... \e[33m\e[5mPlease wait.\e[0m"
		qcount
		echo -en "\r\033[0K"
		echo "queue active = $activ"
	fi
elif [ "$TARGET" == "incoming" ]; then
        if [ "$QUIET" = true ]; then
		qcount
                echo "$incom"
        else
		echo -en "\e[37mCounting queue... \e[33m\e[5mPlease wait.\e[0m"
		qcount
		echo -en "\r\033[0K"
                echo "queue incoming = $incom"
        fi
elif [ "$TARGET" == "hold" ]; then
	if [ "$QUIET" = true ]; then
		qcount
		echo "$hold"
	else
		echo -en "\e[37mCounting queue... \e[33m\e[5mPlease wait.\e[0m"
		qcount
		echo -en "\r\033[0K"
		echo "queue hold = $hold"
	fi
else
	echo -en "\e[37mCounting queue... \e[33m\e[5mPlease wait.\e[0m"
	qcount
	echo -en "\r\033[0K"
	echo -e "\n \e[1m\e[4mPostfix Queue Summary\e[0m"
	printf "%-20s %6s\n" " queue incoming =" "$incom"
	printf "%-20s %6s\n" " queue active   =" "$activ"
	printf "%-20s %6s\n" " queue deferred =" "$defrd"
	printf " \e[4m%-20s %5s\e[0m\n" "queue hold     =" "$qhold"
	printf "%-20s %6s\n" " total queue    =" "$total"
	echo -e "----------------------------"
	echo -e "$mydate"
	echo -e "----------------------------"
fi
